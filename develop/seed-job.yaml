---
apiVersion: batch/v1
kind: Job
metadata:
  name: rhyolite-seed
  annotations:
    # Tells ArgoCD this is a hook (runs during sync)
    argocd.argoproj.io/hook: Sync
    # Optional: Delete the job after it succeeds (replaces ttlSecondsAfterFinished)
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  # Deletes the job 100 seconds after completion, this TTL is useful outside of ArgoCD
  # in order to clean up completed jobs automatically.
  ttlSecondsAfterFinished: 100
  backoffLimit: 1
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-postgres
          image: postgres:16-alpine
          env:
            - name: DATABASE_HOST
              value: postgres
            - name: DATABASE_PORT
              value: "5432"
            - name: DATABASE_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: username
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: password
            - name: DATABASE_NAME
              valueFrom:
                configMapKeyRef:
                  name: postgres-config
                  key: database
          command:
            - sh
            - -c
            - |
              set -eu
              echo "Waiting for Postgres..."
              until PGPASSWORD="$DATABASE_PASSWORD" psql -h "$DATABASE_HOST" -p "$DATABASE_PORT" -U "$DATABASE_USER" -d "$DATABASE_NAME" -c "SELECT 1" >/dev/null 2>&1; do
                echo "...not ready yet"
                sleep 2
              done
              echo "Postgres is reachable."
      containers:
        - name: seed
          image: rhyolite-seed
          imagePullPolicy: IfNotPresent
          env:
            - name: DATABASE_HOST
              value: postgres
            - name: DATABASE_PORT
              value: "5432"
            - name: DATABASE_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: username
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: password
            - name: DATABASE_NAME
              valueFrom:
                configMapKeyRef:
                  name: postgres-config
                  key: database
